/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package HKStack;

import java.io.*;
import java.time.Duration;
import java.time.Instant;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Scanner;
import java.util.Set;

import javax.imageio.ImageIO;
import javax.xml.stream.XMLStreamException;

import edu.iris.dmc.seedcodec.CodecException;
import edu.sc.seis.receiverFunction.*;
import edu.sc.seis.receiverFunction.compare.StationResult;
import edu.sc.seis.receiverFunction.compare.StationResultRef;
import edu.sc.seis.receiverFunction.crust1.Crust1;
import edu.sc.seis.receiverFunction.crust1.Crust1Profile;
import edu.sc.seis.receiverFunction.crust2.Crust2;
import edu.sc.seis.receiverFunction.crust2.Crust2Profile;
import edu.sc.seis.seisFile.SeisFileException;
import edu.sc.seis.seisFile.fdsnws.stationxml.*;
import edu.sc.seis.sod.util.convert.sac.FissuresToSac;
import org.apache.log4j.BasicConfigurator;
import org.json.JSONException;
import org.json.JSONObject;
import org.json.JSONStringer;

import com.martiansoftware.jsap.FlaggedOption;
import com.martiansoftware.jsap.JSAP;
import com.martiansoftware.jsap.JSAPException;
import com.martiansoftware.jsap.JSAPResult;
import com.martiansoftware.jsap.Parameter;
import com.martiansoftware.jsap.QualifiedSwitch;
import com.martiansoftware.jsap.SimpleJSAP;
import com.martiansoftware.jsap.Switch;
import com.martiansoftware.jsap.UnflaggedOption;
import com.martiansoftware.jsap.stringparsers.FileStringParser;

import edu.sc.seis.TauP.TauModelException;
import edu.sc.seis.receiverFunction.hibernate.ReceiverFunctionResult;
import edu.sc.seis.receiverFunction.hibernate.RejectedMaxima;
import edu.sc.seis.seisFile.sac.SacTimeSeries;
import edu.sc.seis.sod.SodConfig;
import edu.sc.seis.sod.model.common.FissuresException;
import edu.sc.seis.sod.model.common.QuantityImpl;
import edu.sc.seis.sod.model.common.UnitImpl;
import edu.sc.seis.sod.model.event.CacheEvent;
import edu.sc.seis.sod.model.seismogram.LocalSeismogramImpl;
import edu.sc.seis.sod.model.station.ChannelGroup;
import edu.sc.seis.sod.util.convert.sac.SacToFissures;
import edu.sc.seis.sod.util.time.ClockUtil;
import edu.sc.seis.sod.web.jsonapi.JsonApi;
import edu.sc.seis.sod.web.jsonapi.JsonApiException;

public class App {
    
    public void config(String[] args) throws JSAPException, IOException, SeisFileException, XMLStreamException {
    	SimpleJSAP jsap = new SimpleJSAP( 
                "HKStack", 
                "Calculate H-K stacks for receiver functions",
                new Parameter[] {
                    new FlaggedOption( "filenamefile", FileStringParser.getParser(), JSAP.NO_DEFAULT, JSAP.NOT_REQUIRED, 'f', JSAP.NO_LONGFLAG, 
                        "File with list of receiver function filenames to include." ),
                    new FlaggedOption( "config", FileStringParser.getParser(), JSAP.NO_DEFAULT, JSAP.NOT_REQUIRED, 'c', JSAP.NO_LONGFLAG, 
                        "File with configuration parameters (json)." ),
						new FlaggedOption( "staxml", FileStringParser.getParser(), JSAP.NO_DEFAULT, JSAP.NOT_REQUIRED, 's', JSAP.NO_LONGFLAG,
								"File network level stationxml." ),
                    new QualifiedSwitch( "verbose", JSAP.STRING_PARSER, JSAP.NO_DEFAULT, JSAP.NOT_REQUIRED, 'v', "verbose", 
                        "Requests verbose output." ),
                    new Switch( "savedefaults", JSAP.NO_SHORTFLAG, "defaultconfig", 
                            "Save default config as config_defaults.json." ),
                    new UnflaggedOption( "filenames", JSAP.STRING_PARSER, JSAP.NO_DEFAULT, JSAP.NOT_REQUIRED, JSAP.GREEDY, 
                        "One or more filenames of receiver functions you would like to stack." )
                }
            );

    	JSAPResult config = jsap.parse(args);    
    	if ( jsap.messagePrinted() ) System.exit( 1 );
    	if (config.getFile("staxml") != null) {
    		BufferedInputStream bis = new BufferedInputStream(new FileInputStream(config.getFile("staxml")));
			FDSNStationXML stationXml = FDSNStationXML.loadStationXML(bis);
			NetworkIterator nIt = stationXml.getNetworks();
			while (nIt.hasNext()) {
				Network n = nIt.next();
				networkList.add(n);
				if (n.getNetworkCode() == "XK") {
					System.out.println("Found an XK network, using id="+n.getNetworkId());
				}
			}
			stationXml.closeReader();
		}
    	if (config.getBoolean("savedefaults")) {

            File outFile = new File("config_default.json");
            PrintWriter out = new PrintWriter(new BufferedWriter(new FileWriter(outFile)));
            out.println(defaultRunParams().toString(2));
            out.close();
            System.out.println("Save defaults to "+outFile);
            System.exit(0);
    	}

        if (config.contains("config")) {
            try {
                runParams = loadConfigFile(config.getFile("config"));
            } catch (JSONException e) {
                throw new RuntimeException("can't happen",e);
            } catch (JsonApiException e) {
                throw new RuntimeException("can't happen",e);
            }
        } else {
            runParams = defaultRunParams();
        }

    	if (config.contains("filenamefile")) {
    		Scanner scanner = new Scanner(config.getFile("filenamefile"));
    		while (scanner.hasNextLine()) {
    			String line = scanner.nextLine();
    			filenameList.add(line.strip());
    		}
    	} else if (config.contains("filenames")) {
    		filenameList = List.of(config.getStringArray("filenames"));
    	} else {
    		System.err.println();
    		System.err.println("Usage: HKStack ");
    		System.err.println("                "
    				+ jsap.getUsage());
    		System.err.println();
    		System.exit(1);
    	}
    	
    }
    
    public void saveRunParams(File configfile) throws JSONException, IOException {
        BufferedWriter writer = new BufferedWriter(new FileWriter(configfile));
        writer.write(runParams.toString(2));
        writer.close();
    }
    
    public JSONObject defaultRunParams() {
        JSONObject json = new JSONObject();
        json.put("doimage", true);
        json.put("dovalues", false);
		json.put("donormvalues", false);
		json.put("dosynthmaxima", false);
        json.put("doreport", true);
        json.put("alpha", "0.0");
		json.put("alpha_from", "crust2.0");
        JSONObject hObj = new JSONObject();
        hObj.put("min", 25);
        hObj.put("step", .25);
        hObj.put("num", 100);
        json.put("h", hObj);
        JSONObject kObj = new JSONObject();
        kObj.put("min", 1.5);
        kObj.put("step", .005);
        kObj.put("num", 100);
        json.put("k", kObj);
        JSONObject wObj = new JSONObject();
        wObj.put("Ps", 1.0f/3);
        wObj.put("PpPs", 1.0f/3);
        wObj.put("PsPs", "remainder");
        json.put("weight", wObj);
        json.put("minPercentMatch", 80.0);
        json.put("dobootstrap", false);
        json.put("bootstrapIterations", 100);
        return json;
    }
    
    public void doit() throws IOException, FissuresException, TauModelException, CodecException {
        System.out.println("doit");
    	List<ReceiverFunctionResult> individuals = new ArrayList<ReceiverFunctionResult>();


        boolean doImage = runParams.optBoolean("doimage", true);
		boolean doValues = runParams.optBoolean("dovalues", false);
		boolean doNormValues = runParams.optBoolean("donormvalues", false);
		boolean doSynthMaxima = runParams.optBoolean("dosynthmaxima", false);
		QuantityImpl alpha;
		if (runParams.has("alpha_from")) {
			if (runParams.getString("alpha_from").equalsIgnoreCase("crust2.0")) {
				alpha = null;
				runParams.put("alpha", "0.0");
			} else if (runParams.getString("alpha_from").equalsIgnoreCase("crust1.0")) {
				alpha = null;
				runParams.put("alpha", "0.0");
			} else {
                throw new FissuresException("Do not understand \"alpha_from\": "+runParams.getString("alpha_from"));
			}
		} else {
			runParams.put("alpha_from", "fixed");
			if (runParams.has("alpha")) {
				alpha = new QuantityImpl(runParams.getDouble("alpha"), UnitImpl.KILOMETER_PER_SECOND);
			} else {
				alpha = new QuantityImpl(6.1, UnitImpl.KILOMETER_PER_SECOND);
				runParams.put("alpha", alpha.formatValue("0.00"));
			}
		}
		JSONObject hObj = runParams.getJSONObject("h");
        QuantityImpl minH = new QuantityImpl(hObj.optDouble("min", 25), UnitImpl.KILOMETER);
        QuantityImpl stepH = new QuantityImpl(hObj.optDouble("step", .25), UnitImpl.KILOMETER);
        int numH = hObj.optInt("num", 100);
        System.out.println("H "+minH+" "+stepH+" "+numH);

        JSONObject kObj = runParams.getJSONObject("k");
        float minK = (float) kObj.optDouble("min", 1.5f);
        float stepK = (float) kObj.optDouble("step", 0.005f);
        int numK = kObj.optInt("num", 100);
        System.out.println("K "+minK+" "+stepK+" "+numK);

        JSONObject wObj = runParams.getJSONObject("weight");
        float weightPs = (float) wObj.optDouble("Ps", 1.0f/3);
        float weightPpPs = (float) wObj.optDouble("PpPs", 1.0f/3);
        float weightPsPs = 1 - weightPs - weightPpPs;

        float minPercentMatch = (float) runParams.optDouble("minPercentMatch", 80.0f);

        boolean doBootstrap = runParams.optBoolean("dobootstrap", false);
        int bootstrapIterations = runParams.optInt("bootstrapIterations", 100);
        
        boolean doReport = runParams.optBoolean("doreport", true);
        
    	Channel chan = null;
    	String netCodeYear = null;
    	int numEventsInput = 0;
    	for (String sacfilename: filenameList ) {

    		SacTimeSeries sac = SacTimeSeries.read(sacfilename);
			LocalSeismogramImpl recFuncSeis = SacToFissures.getSeismogram(sac);
    		if (chan == null) {
    	    	Network net = new Network(sac.getHeader().getKnetwk().strip());
				if (net.isTemporary()) {
					// set start year as sac year just in case
					net.setStartDateTime(Instant.parse(sac.getHeader().getNzyear()+"-01-01T00:00:00Z"));
				    for (Network n: networkList ) {
					    if (n.getNetworkCode() == net.getNetworkCode()
								&& n.getStartDateTime().isBefore(recFuncSeis.getBeginTime())
								&& n.getEndDateTime().isAfter(recFuncSeis.getBeginTime())) {
					    	// net overlaps seismogram
							net = n;
							break;
						}
					}
				} else {
					for (Network n : networkList) {
						if (n.getNetworkCode() == net.getNetworkCode()) {
							net = n;
						}
					}
				}

    	    	Station sta = new Station(net, sac.getHeader().getKstnm().strip());
				System.out.println("Updating network in channel for "+sta.getStationCode()+" to be "+net.getNetworkId());
    	    	chan = new Channel(sta, sac.getHeader().getKhole().strip(), sac.getHeader().getKcmpnm().strip());
    	    	System.out.println(("Channel: "+chan.getSourceId()));
    	    	chan.setElevation(sac.getHeader().getStel());
    	    	chan.setDepth(sac.getHeader().getStdp());
    	    	chan.setLatitude(sac.getHeader().getStla());
    	    	chan.setLongitude(sac.getHeader().getStlo());
				if (runParams.getString("alpha_from").equalsIgnoreCase("crust2.0")) {
					Crust2 crust2 = new Crust2();
					Crust2Profile profile = crust2.getClosest(chan.getLongitudeFloat(), chan.getLatitudeFloat());
					alpha = new QuantityImpl(profile.getPWaveAvgVelocity(), UnitImpl.KILOMETER_PER_SECOND);
					runParams.put("alpha", alpha.formatValue("0.00"));
				} else if (runParams.getString("alpha_from").equalsIgnoreCase("crust1.0")) {
					Crust1 crust1 = new Crust1();
					Crust1Profile profile = crust1.getClosest(chan.getLongitudeFloat(), chan.getLatitudeFloat());
					alpha = new QuantityImpl(profile.getPWaveAvgVelocity(), UnitImpl.KILOMETER_PER_SECOND);
					runParams.put("alpha", alpha.formatValue("0.00"));
				}
    		}
    		float percentMatch = sac.getHeader().getUser0();
    		float quassianWidth = sac.getHeader().getUser1();
    		float rayParam = sac.getHeader().getUser2();
    		System.out.println(sacfilename+": percentMatch "+percentMatch+"  quassianWidth: "+quassianWidth+"  rayParam:"+rayParam);
    		if (percentMatch < 0) {percentMatch = 0;}
    		if (rayParam < 0) {
    			throw new FissuresException("rayParam is undefined in sac file: "+rayParam+" for "+sacfilename);
    		}

    		Duration shift = ClockUtil.durationOfSeconds(sac.getHeader().getA()-sac.getHeader().getB());

    		HKStack stack = new HKStack(alpha,
    				rayParam,
    				quassianWidth,
    				percentMatch,
    				minH,
    				stepH,
    				numH,
    				minK,
    				stepK,
    				numK,
    				weightPs,
    				weightPpPs,
    				weightPsPs,
    				recFuncSeis,
    				shift);
    		CacheEvent event = null;
    		Channel[] chanArr = new Channel[] { chan }; // fake it to get station codes into stacker
    		ChannelGroup channelGroup = new ChannelGroup(chanArr);
    		LocalSeismogramImpl original1 = null;
    		LocalSeismogramImpl original2 = null;
    		LocalSeismogramImpl original3 = null;
    		LocalSeismogramImpl radial = recFuncSeis;
    		LocalSeismogramImpl transverse = null;
    		float radialMatch = percentMatch;
    		int radialBump = 0;
    		float transverseMatch = 0;
    		int transverseBump = 0;
    		float gwidth = quassianWidth;
    		int maxBumps = 400;
    		float tol = 1;
    		SodConfig config = null;
    		ReceiverFunctionResult rfResult = new ReceiverFunctionResult(event,
    				channelGroup,
    				original1,
    				original2,
    				original3,
    				radial, 
    				transverse,
    				radialMatch,
    				radialBump,
    				transverseMatch,
    				transverseBump,
    				gwidth,
    				maxBumps,
    				tol,
    				config);

    		rfResult.setHKstack(stack);
    		individuals.add(rfResult);

    	}

    	QuantityImpl smallestH = new QuantityImpl(10, UnitImpl.KILOMETER);

    	boolean usePhaseWeight = true;
    	Set<RejectedMaxima> rejects = new HashSet<RejectedMaxima>();
    	String phase = "";
    	SumHKStack sumStack = SumHKStack.calculateForPhase(individuals,
    			smallestH,
    			minPercentMatch,
    			usePhaseWeight,
    			rejects,
    			doBootstrap,
    			bootstrapIterations,
    			phase);
    	sumStack.calcStackComplexity();
    	HKStack sumHK = sumStack.getSum();
		StackMaximum[] localMaxima = sumHK.getLocalMaxima(smallestH, 5);

    	if (doValues) {
			writeStackXYZ("hkstack_"+chan.getNetworkId()+"."+chan.getStationCode()+".xyz", sumHK);
    	}
		if (doNormValues) {
			int numEQ = sumStack.getNumEQ();
			float[][] stackVals = sumHK.getStack();
			float[][] normed = new float[stackVals.length][stackVals[0].length];
			for (int i=0; i<stackVals.length; i++) {
				for (int j=0; j<stackVals[i].length; j++) {
					normed[i][j] = stackVals[i][j] / numEQ;
				}
			}
			HKStack normHK = new HKStack(sumHK.getAlpha(),
					sumHK.getP(),
					sumHK.getGaussianWidth(),
					sumHK.getPercentMatch(),
					sumHK.getMinH(),
					sumHK.getStepH(),
					sumHK.getNumH(),
					sumHK.getMinK(),
					sumHK.getStepK(),
					sumHK.getNumK(),
					sumHK.getWeightPs(),
					sumHK.getWeightPpPs(),
					sumHK.getWeightPsPs(),
					normed);
			writeStackXYZ("hkstack_norm_"+chan.getNetworkId()+"."+chan.getStationCode()+".xyz", normHK);
		}
    	if (doSynthMaxima) {
			StationResultRef earsStaRef = new StationResultRef("Global Maxima",
					"ears",
					"ears");
			StationResult staResult = new StationResult(chan.getNetworkId(),
					chan.getStationCode(),
					sumStack.getSum().getMaxValueH(sumStack.getSmallestH()),
					sumStack.getSum().getMaxValueK(sumStack.getSmallestH()),
					sumStack.getSum().getAlpha(),
					earsStaRef);
			StackComplexity complexity = new StackComplexity(sumStack.getSum(),
					sumStack.getGaussianWidth());
			ReceiverFunctionResult rfr = complexity.getSynthetic(staResult);
			SacTimeSeries sacRadial = FissuresToSac.getSAC(rfr.getRadial());
			sacRadial.write("synth_"+chan.getNetworkId()+"."+chan.getStationCode()+"."+chan.getLocCode()+"."+chan.getChannelCode()+".sac");
    		HKStack maxima = rfr.getHKstack();
			writeStackXYZ("synthstack_max_"+chan.getNetworkId()+"."+chan.getStationCode()+".xyz", maxima);
		}
    	if (doImage) {
    		HKStackImage stackImage = new HKStackImage(sumHK);
    		ImageIO.write(stackImage.createImage(400, 400), "png", new File("hkstack_"+chan.getNetworkId()+"."+chan.getStationCode()+".png"));

    	}
    	if (doReport) {
            File outFile = new File("report_"+chan.getNetworkId()+"."+chan.getStationCode()+".json");
            PrintWriter out = new PrintWriter(new BufferedWriter(new FileWriter(outFile)));
            JSONStringer json = new JSONStringer();
            json.object();
            json.key("sumhk");
            sumStack.reportJson(json);
            
            json.key("config").value(runParams);
			json.key("numEventsInput").value(filenameList.size());
            json.key("numEventsUsed").value(sumStack.getNumEQ());
            json.endObject();
            
            JSONObject formated = new JSONObject(json.toString());
            out.print(formated.toString(2));
            out.close();
    	}

        File outFile = new File("config_"+chan.getNetworkId()+"."+chan.getStationCode()+".json");
        PrintWriter out = new PrintWriter(new BufferedWriter(new FileWriter(outFile)));
        out.println(runParams.toString(2));
        out.close();
    }

    public void writeStackXYZ(String filename, HKStack sumHK) throws IOException {
		File outFile = new File(filename);
		PrintWriter out = new PrintWriter(new BufferedWriter(new FileWriter(outFile)));
		float[][] stackVals = sumHK.getStack();
		for(int j = 0; j < stackVals.length; j++) {
			QuantityImpl hQ = sumHK.getHFromIndex(j);
			double hVal = hQ.getValue(UnitImpl.KILOMETER);
			for(int k = 0; k < stackVals[j].length; k++) {
				float kVal = sumHK.getKFromIndex(k);
				out.println(kVal+" "+hVal+" "+stackVals[j][k]+" ");
			}
		}
		out.close();
	}

    public JSONObject loadConfigFile(File configfile) throws JSONException, IOException, JsonApiException {
        BufferedReader in = null;
        try {
            if (configfile.exists()) {
                in = new BufferedReader(new FileReader(configfile));

                String rawJson = JsonApi.loadFromReader(in);
                JSONObject json = new JSONObject(rawJson);
                return json; 
            } else {
                throw new IOException("can't find or open config file: "+configfile);
            }
        } finally {
            if (in != null) {
                try {
                    in.close();
                } catch(IOException e) {
                    // oh well
                }
            }
        }
    }
    
    List<String> filenameList = new ArrayList<String>();
    JSONObject runParams;
	List<Network> networkList = new ArrayList<Network>();

    public static void main(String[] args) throws FileNotFoundException, IOException, FissuresException, JSAPException {
        try {
            BasicConfigurator.configure();
            System.out.println("Start");
        App app = new App();
        app.config(args);
        app.doit();
        System.out.println("Done");
        } catch(Exception e) {
            e.printStackTrace();
        
        }
    }
}
